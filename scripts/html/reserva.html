<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reserva - Sapori d'Italia</title>

  <link rel="shortcut icon" href="../imagens/imagem-home/italian restaurant chapeu.png" type="image/x-icon">
  <link rel="stylesheet" href="../css/style_reserva.css">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


</head>

<body>
  <div class="foto"> </div>
  
  <header>
    <h1><a href="index.html">Sapori d'Italia</a></h1>
    <p>Garanta seu lugar em nossa mesa</p>
  </header>

  <div class="container">

    <h2>Nova Reserva</h2>

    <form id="reservaForm">
      <input type="hidden" id="usuarioId">

      <div>
        <label for="nome">Nome completo</label>
        <input type="text" id="nome" name="nome" placeholder="Nome completo" required readonly
          style="background-color: #f0f0f0;" />
      </div>

      <div>
        <label for="email">E-mail</label>
        <input type="email" id="email" name="email" placeholder="E-mail" required readonly
          style="background-color: #f0f0f0;" />
      </div>

      <div>
        <label for="telefone">Telefone (WhatsApp)</label>
        <input type="tel" id="telefone" name="telefone" placeholder="(00) 00000-0000" required />
      </div>

      <div>
        <label for="data">Data da reserva</label>
        <input type="date" id="data" name="data" required />
      </div>

      <label>Hor치rio</label>
      <select id="horario" name="horario" required>
        <option value="">Selecione um hor치rio</option>
      </select>

      <div>
        <label for="pessoas">N칰mero de pessoas</label>
        <select id="pessoas" name="pessoas" required>
          <option value="">Selecione</option>
          <option value="1">1 pessoa</option>
          <option value="2">2 pessoas (Casal)</option>
          <option value="3">3 pessoas</option>
          <option value="4">4 pessoas</option>
          <option value="5">5 pessoas</option>
          <option value="6">6 pessoas</option>
          <option value="Grupo">Mais de 6 (Ligar para o restaurante)</option>
        </select>
      </div>

      <button type="submit" id="btnReservar">Confirmar Reserva</button>
    </form>
  </div>

  <script>
    // URL da API
    const API_URL = 'http://127.0.0.1:3000';

    // 1. CONFIGURA칂츾O INICIAL (Data e Hor치rio)
    const dataInput = document.getElementById('data');
    const horarioSelect = document.getElementById('horario');

    // Data m칤nima = Hoje
    const hoje = new Date();
    const minDate = hoje.toISOString().split('T')[0];
    dataInput.min = minDate;

    // Preenche hor치rios
    const horarios = ["18:00", "18:30", "19:00", "19:30", "20:00", "20:30", "21:00", "21:30", "22:00"];
    horarios.forEach(hora => {
      const opt = document.createElement('option');
      opt.value = hora;
      opt.innerText = hora;
      horarioSelect.appendChild(opt);
    });

    // 2. DINAMISMO: Preencher dados do usu치rio logado
    function verificarLogin() {
      const userString = localStorage.getItem('usuarioLogado');

      if (!userString) {
        // Se n칚o estiver logado, avisa e manda pro login
        Swal.fire({
          title: 'Login Necess치rio',
          text: 'Para fazer uma reserva, voc칡 precisa entrar na sua conta.',
          icon: 'info',
          confirmButtonText: 'Ir para Login'
        }).then(() => {
          window.location.href = 'login.html';
        });
        return;
      }

      const usuario = JSON.parse(userString);

      // Preenche os campos automaticamente
      document.getElementById('usuarioId').value = usuario.id;
      document.getElementById('nome').value = usuario.nome;
      document.getElementById('email').value = usuario.email || ''; // Se tiver email no objeto, preenche

      // Tenta buscar o telefone completo do banco (opcional, mas legal)
      fetch(`${API_URL}/usuarios/${usuario.id}`)
        .then(res => res.json())
        .then(dadosCompletos => {
          if (dadosCompletos.telefone) {
            document.getElementById('telefone').value = dadosCompletos.telefone;
          }
          if (dadosCompletos.email) {
            document.getElementById('email').value = dadosCompletos.email;
          }
        });
    }

    // 3. ENVIAR PRO BANCO DE DADOS
    document.getElementById('reservaForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('btnReservar');
      const textoOriginal = btn.innerText;

      // Dados para enviar
      const novaReserva = {
        usuarioId: document.getElementById('usuarioId').value,
        data_reserva: document.getElementById('data').value,
        horario: document.getElementById('horario').value,
        numero_pessoas: document.getElementById('pessoas').value,
        // Podemos salvar o telefone atualizado caso o usu치rio mude aqui
        status: 'Confirmada'
      };

      try {
        btn.innerText = "Reservando...";
        btn.disabled = true;

        const response = await fetch(`${API_URL}/reservas`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(novaReserva)
        });

        if (response.ok) {
          Swal.fire({
            title: 'Reserva Confirmada! 游꽁',
            text: `Te esperamos dia ${novaReserva.data_reserva} 맙 ${novaReserva.horario}.`,
            icon: 'success'
          }).then(() => {
            window.location.href = 'index.html'; // Ou redirecionar para 'Meus Pedidos'
          });
        } else {
          Swal.fire('Erro', 'N칚o foi poss칤vel reservar. Tente outro hor치rio.', 'error');
        }

      } catch (erro) {
        console.error(erro);
        Swal.fire('Erro', 'Falha na conex칚o com o servidor.', 'error');
      } finally {
        btn.innerText = textoOriginal;
        btn.disabled = false;
      }
    });

    // Executa ao abrir a p치gina
    verificarLogin();

  </script>
</body>

</html>