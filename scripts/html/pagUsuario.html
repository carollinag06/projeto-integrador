<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Perfil - Sapori</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../css/style_pagUsuario.css">

  <style>
    /* Estilos para garantir que fique bonito mesmo se o CSS externo falhar */
    body { font-family: 'Inter', sans-serif; display: flex; justify-content: center; padding-top: 30px; background-color: #f4f4f4; }
    
    .profile-card { 
        background: white; 
        padding: 30px; 
        border-radius: 10px; 
        width: 100%; 
        max-width: 400px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    }

    .info-group {
        border-bottom: 1px solid #eee;
        padding: 12px 0;
        display: flex;
        justify-content: space-between; /* Separa o label do valor */
    }

    .label { font-weight: bold; color: #666; }
    .value { color: #333; font-weight: 500; text-align: right; }

    .btn-sair {
        width: 100%; padding: 12px; background-color: #dc3545; color: white; 
        border: none; cursor: pointer; font-size: 16px; margin-top: 20px;
        border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-sair:hover { background-color: #b02a37; }
    
    .btn-voltar { border: none; background: none; cursor: pointer; color: #555; margin-bottom: 15px;}
  </style>
</head>

<body>

  <div class="profile-card">
    <button class="btn-voltar" onclick="window.location.href='index.html'">← Voltar ao Menu</button>
    
    <h1 style="text-align: center;">Meu Perfil</h1>
    
    <div id="loading" style="text-align: center; color: #666;">Carregando informações...</div>

    <div id="conteudo-perfil" style="display: none;">
        
        <div class="info-group">
            <span class="label">Nome:</span>
            <span class="value" id="nome">-</span>
        </div>

        <div class="info-group">
            <span class="label">Email:</span>
            <span class="value" id="email">-</span>
        </div>

        <div class="info-group">
            <span class="label">Telefone:</span>
            <span class="value" id="telefone">-</span>
        </div>
        
        <div class="info-group">
            <span class="label">CPF:</span>
            <span class="value" id="cpf">-</span>
        </div>

        <div class="info-group">
            <span class="label">Pratos Favoritos:</span>
            <span class="value" id="pratos">-</span>
        </div>

        <div class="info-group">
            <span class="label">Frequência:</span>
            <span class="value" id="frequencia">-</span>
        </div>

        <div class="info-group">
            <span class="label">Cliente desde:</span>
            <span class="value" id="data_cadastro">-</span>
        </div>

        <button type="button" class="btn-sair" onclick="funcaoSair()">
            <i class="bi bi-box-arrow-right"></i> SAIR DA CONTA
        </button>
    </div>
  </div>

  <script>
    const API_URL = 'http://127.0.0.1:3000';

    // 1. FUNÇÃO DE SAIR
    function funcaoSair() {
        // Remove a linha abaixo se quiser tirar o alerta de teste
        // alert("Botão clicado!"); 
        
        if(confirm("Deseja realmente sair da sua conta?")) {
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('idUsuario');
            window.location.href = 'index.html';
        }
    }

    // 2. FUNÇÃO PARA FORMATAR DATA (Do padrão americano para BR)
    function formatarData(dataString) {
        if (!dataString) return '-';
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR'); // Retorna dd/mm/aaaa
    }

    // 3. CARREGAR DADOS DO BANCO
    async function carregar() {
        const dadosLocal = localStorage.getItem('usuarioLogado');
        
        if(!dadosLocal) {
            window.location.href = 'login.html';
            return;
        }

        try {
            const usuarioObj = JSON.parse(dadosLocal);
            
            // Chama a API pelo ID
            const res = await fetch(`${API_URL}/usuarios/${usuarioObj.id}`);
            
            if(res.ok) {
                const info = await res.json();
                
                // --- PREENCHENDO OS CAMPOS ---
                
                // Campos Texto Simples
                document.getElementById('nome').innerText = info.nome || 'Sem nome';
                document.getElementById('email').innerText = info.email || '-';
                document.getElementById('telefone').innerText = info.telefone || 'Não informado';
                document.getElementById('cpf').innerText = info.cpf || 'Não informado';
                document.getElementById('pratos').innerText = info.pratos_preferidos || 'Nenhum';
                
                // Campo Número + Texto
                const visitas = info.frequencia_visitas || 0;
                document.getElementById('frequencia').innerText = visitas + ' visitas';

                // Campo Data (Formatada)
                document.getElementById('data_cadastro').innerText = formatarData(info.DataHoraCadastro);

                // Mostra a tela bonita
                document.getElementById('loading').style.display = 'none';
                document.getElementById('conteudo-perfil').style.display = 'block';
            } else {
                alert("Erro ao buscar dados atualizados.");
            }
        } catch(e) {
            console.error(e);
            document.getElementById('loading').innerText = "Erro de conexão com o servidor.";
            document.getElementById('loading').style.color = "red";
        }
    }

    // Inicia tudo
    carregar();
  </script>
</body>
</html>